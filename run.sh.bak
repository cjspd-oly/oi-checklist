#!/bin/bash
set -e
set -o pipefail

# ------------------------------
# Kill existing processes on ports
# ------------------------------
for PORT in 5001 5501; do
    PID=$(sudo lsof -t -i :$PORT)
    if [ -z "$PID" ]; then
        echo "[INFO] No process found running on port $PORT."
    else
        echo "[INFO] Killing process with PID $PID running on port $PORT..."
        sudo kill -9 $PID
        echo "[INFO] Process on port $PORT killed successfully."
    fi
done

# ------------------------------
# Activate virtual environment
# ------------------------------
if [ ! -d "venv" ]; then
    echo "[ERROR] Virtual environment not found. Run setup.sh first."
    exit 1
fi

echo "[INFO] Activating virtual environment..."
source venv/bin/activate

# ------------------------------
# Run backend
# ------------------------------
echo "[INFO] Starting Flask backend..."
python3 backend/app.py &
BACKEND_PID=$!

# Give backend a few seconds to start
sleep 2

# ------------------------------
# Run frontend
# ------------------------------
echo "[INFO] Starting frontend server..."
python3 custom_server.py &
FRONTEND_PID=$!

echo "[INFO] Backend PID: $BACKEND_PID"
echo "[INFO] Frontend PID: $FRONTEND_PID"

# ------------------------------
# Wait for both processes to finish
# ------------------------------
wait $BACKEND_PID $FRONTEND_PID
